<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Рекомендации по уходу за кожей</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
</head>
<body>
    <div class="container">
        <h1>Рекомендации по уходу за кожей</h1>

        <form id="uploadForm" enctype="multipart/form-data">
            <label>Загрузите фотографию:</label>
            <input type="file" name="image" required><br>

            <label>Возраст (от 1 до 120):</label>
            <input type="number" name="age" id="age" min="1" max="120" required>

            <label>Пол:</label>
            <div class="radio-group">
                <label><input type="radio" name="gender" value="муж" required> Мужской</label>
                <label><input type="radio" name="gender" value="жен"> Женский</label>
            </div>
            <label>Есть ли аллергия:</label>
            <select name="allergies" required>
                <option value="нет">Нет</option>
                <option value="эфирные масла">Эфирные масла</option>
                <option value="растительные экстракты">Растительные экстракты</option>
                <option value="отдушки и парфюмерные композиции">Отдушки и парфюмерные композиции</option>
                <option value="парабены">Парабены</option>
                <option value="красители">Красители</option>
                <option value="ланолин">Ланолин</option>
                <option value="силиконы">Силиконы</option>
                <option value="минеральные масла">Минеральные масла</option>
                <option value="кислоты">Кислоты</option>
                <option value="продукты пчеловодства">Продукты пчеловодства</option>
            </select><br>

            <button type="submit">Отправить</button>
            </form>

            <div id="result"></div>
            </div>

            <script>
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(uploadResp) {
                // После загрузки — анализ
                $.ajax({
                    url: '/analyze',
                    type: 'POST',
                    data: {
                        age: $('input[name="age"]').val(),
                        gender: $('input[name="gender"]:checked').val(),
                        allergies: $('select[name="allergies"]').val(),
                        filename: uploadResp.filename
                    },
                    success: function(response) {
                        if (response.error) {
                            $('#result').html(`<div class="error">Ошибка: ${response.error}</div>`);
                            return;
                        }

                        let html = `<h3>Результат анализа</h3>
                                    <p><strong>Тип кожи:</strong> ${response.probs}</p>
                                    <p><strong>Доминирующий тип:</strong> ${response.label}</p>
                                    <p><strong>Рекомендации по уходу:</strong> ${response.receipt}</p>`;

                        html += `<h3>История</h3>
                                 <table>
                                     <thead>
                                         <tr>
                                             <th>ID</th>
                                             <th>Возраст</th>
                                             <th>Пол</th>
                                             <th>Аллергия</th>
                                             <th>Доминирующий</th>
                                             <th>Типы</th>
                                         </tr>
                                     </thead>
                                     <tbody>`;
                        response.history.forEach(row => {
                            html += `<tr>
                                        <td>${row.id}</td>
                                        <td>${row.age}</td>
                                        <td>${row.gender}</td>
                                        <td>${row.allergies}</td>
                                        <td>${row.label}</td>
                                        <td>${row.probs}</td>
                                     </tr>`;
                        });
                        html += '</tbody></table>';
                        $('#result').html(html);
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.error || 'Неизвестная ошибка при анализе';
                        $('#result').html(`<div class="error">Ошибка: ${errorMsg}</div>`);
                    }
                });
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON?.error || 'Не удалось загрузить изображение';
                $('#result').html(`<div class="error">Ошибка: ${errorMsg}</div>`);
            }
        });
    });
</script>

</body>
</html>
